// Event Management System - Prisma Schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearchPostgres"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NO_SSL")
}

// 0. Host - The user/business who creates and manages events
model Host {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  passwordHash  String // bcrypt hashed password
  emailVerified DateTime? // Email verification status
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  eventLineups EventLineup[] // Events they organize
  sessions     Session[] // Login sessions

  @@index([email])
}

// 0.1. Session - Login session management
model Session {
  id        String   @id @default(cuid())
  hostId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  host Host @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@index([token])
  @@index([expiresAt])
}

// 1. Event Lineup - The main event (wedding, house warming, etc.)
model EventLineup {
  id             String   @id @default(cuid())
  hostId         String // Link to Host who created this
  title          String // e.g., "Sarah & John's Wedding"
  slug           String   @unique // URL-friendly identifier
  eventCategory  String // e.g., "wedding", "corporate", "birthday", "house-warming", "conference"
  organizerName  String // Main contact/organizer name (e.g., "Sarah Johnson" or "David & Lisa Miller")
  organizerEmail String // Organizer's email for communications
  groomName      String? // Optional: for weddings
  brideName      String? // Optional: for weddings
  description    String?  @db.Text
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  host       Host    @relation(fields: [hostId], references: [id], onDelete: Cascade)
  events     Event[]
  guestLists Guest[]

  @@index([hostId])
  @@index([slug])
  @@index([isActive])
  @@index([eventCategory])
}

// 2. Events - Individual events within a lineup (ceremony, reception, etc.)
model Event {
  id          String   @id @default(cuid())
  lineupId    String
  slug        String // e.g., "ceremony", "reception", "sangeet"
  name        String // Display name: "Wedding Ceremony", "Reception Dinner"
  description String?  @db.Text
  date        DateTime // Event date
  time        String // Display time (e.g., "6:00 PM")
  epochTime   BigInt // Unix timestamp for sorting/filtering
  timezone    String // e.g., "America/New_York", "Asia/Kolkata"
  venue       String // Venue name
  address     String // Full address
  addressUrl  String? // Google Maps or venue website URL
  dressCode   String? // e.g., "Formal", "Traditional Indian", "Cocktail"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lineup      EventLineup  @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  invitations Invitation[] // Which guests are invited to this event
  responses   Response[]

  @@unique([lineupId, slug])
  @@index([lineupId])
  @@index([date])
  @@index([epochTime])
}

// 3. Guest List - Guests associated with event lineup
model Guest {
  id        String   @id @default(cuid())
  lineupId  String
  fullName  String
  email     String? // Optional - will be updated when guest responds
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineup      EventLineup  @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  invitations Invitation[] // Which events this guest is invited to
  responses   Response[]
  emailLogs   EmailLog[]

  @@unique([lineupId, fullName]) // Prevent duplicate guest names within same lineup
  @@index([lineupId])
  @@index([email])
}

// 3.1. Invitation - Junction table connecting guests to specific events they're invited to
model Invitation {
  id            String   @id @default(cuid())
  guestId       String
  eventId       String
  attendeeLimit Int      @default(-1) // -1 = no limit, positive number = max attendees (including guest) for this specific event
  isInvited     Boolean  @default(true) // Can be used to revoke invitation
  invitedAt     DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([guestId, eventId]) // One invitation per guest per event
  @@index([guestId])
  @@index([eventId])
  @@index([isInvited])
}

// 4. Response - RSVP responses for specific events
model Response {
  id            String   @id @default(cuid())
  guestId       String
  eventId       String
  isAttending   Boolean
  attendeeCount Int      @default(1) // Number of people attending (including the guest)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([guestId, eventId])
  @@index([guestId])
  @@index([eventId])
  @@index([isAttending])
}

// 5. Email Log - Track email communications
model EmailLog {
  id        String   @id @default(cuid())
  guestId   String
  emailType String // "invitation", "confirmation", "reminder", "update"
  subject   String?
  status    String // "sent", "failed", "pending", "delivered", "opened"
  resendId  String? // ID from email service (e.g., Resend)
  error     String?  @db.Text
  sentAt    DateTime @default(now())
  metadata  Json? // Additional data (e.g., event details, template used)

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
  @@index([status])
  @@index([emailType])
  @@index([sentAt])
}
